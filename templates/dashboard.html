<!doctype html>
<html lang="en-AU">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Novatar â€” Dashboard</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    body{font-family:Inter,system-ui;background:#041022;color:#eaf0ff;margin:0;padding:40px}
    .wrap{max-width:1000px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:18px}
    .card{background:linear-gradient(180deg,#061628,#04101a);padding:18px;border-radius:12px}
    input,select,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#071a2a;color:#eaf0ff}
    input[type="color"]{height:44px;padding:4px;cursor:pointer}
    .btn{background:#7c5cff;border:none;color:#fff;padding:10px;border-radius:8px}
    .muted{color:#98a6c8;font-size:13px}
    .preview{height:128px; width: 128px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:#081626;display:flex;align-items:center;justify-content:center}
    a.logout{display:inline-block;margin-top:10px;color:#ffb3b3}
    .color-preview{width:30px;height:30px;border-radius:6px;border:2px solid rgba(255,255,255,0.1)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2 style="margin:0">Hello, {{ user.username }}</h2>
    <div class="muted" style="margin-top:6px">Manage your Novatar settings and preview your global avatar.</div>

    <label style="margin-top:12px">Avatar source</label>
    <select id="source">
      <option value="github">GitHub Profile</option>
      <option value="initials">Initials</option>
      <option value="url">Image URL</option>
      <option value="gravatar">Gravatar (email)</option>
    </select>

    <div id="source-fields"></div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" id="saveBtn">Save changes</button>
      <form method="get" action="/logout" style="display:inline"><button class="btn" type="submit" style="background:#ff6b6b">Logout</button></form>
    </div>

    <div class="muted" style="margin-top:10px">Your avatar URL: <code style="background:#0b1520;padding:6px;border-radius:6px;color:#9fb0ff">/avatar/{{ user.username }}.png</code></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Live preview</h3>
    <div class="preview" id="previewBox">
      <img id="previewImg" src="/avatar/{{ user.username }}.png" style="width:100%;height:100%;object-fit:cover" alt="avatar">
    </div>
    <div class="muted" style="margin-top:8px">Public avatar link: <a style="color:#9fb0ff" href="/avatar/{{ user.username }}.png" target="_blank">View image</a></div>
  </div>
</div>

<script>
const userData = {{ user|tojson }};
const source = document.getElementById('source');
const srcFields = document.getElementById('source-fields');
const previewImg = document.getElementById('previewImg');

function setFieldsFromUser() {
  const type = userData.avatar?.type || 'github';
  source.value = type;
  renderFields();

  if (type === 'github') {
    const el = document.getElementById('gh');
    if (el) el.value = userData.avatar?.gh_username || '';
  }
  if (type === 'initials') {
    const initials = document.getElementById('initials');
    const bg = document.getElementById('bg');
    const fg = document.getElementById('fg');
    if (initials) initials.value = userData.avatar?.initials || '';
    if (bg) { bg.value = userData.avatar?.bg || '#7c5cff'; document.getElementById('colorPreview').style.background = bg.value || '#7c5cff'; }
    if (fg) { fg.value = userData.avatar?.fg || '#ffffff'; document.getElementById('fgPreview').style.background = fg.value || '#ffffff'; }
  }
  if (type === 'url') {
    const el = document.getElementById('imgurl');
    if (el) el.value = userData.avatar?.url || '';
  }
  if (type === 'gravatar') {
    const el = document.getElementById('gemail');
    if (el) el.value = userData.avatar?.email || '';
  }
  updatePreview();
}

function renderFields(){
  const v = source.value;
  srcFields.innerHTML='';
  if (v === 'github') {
    srcFields.innerHTML = `<label>GitHub username</label><input id="gh">`;
  }
  else if (v === 'initials') {
    srcFields.innerHTML = `
      <label>Initials (1-2 letters)</label>
      <input id="initials" maxlength="2">
      <label>Background color</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input type="color" id="bg" style="flex:1">
        <div id="colorPreview" class="color-preview"></div>
      </div>
      <label>Text color</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input type="color" id="fg" style="flex:1">
        <div id="fgPreview" class="color-preview"></div>
      </div>
    `;
    const bgInput = document.getElementById('bg');
    const fgInput = document.getElementById('fg');
    const bgPreview = document.getElementById('colorPreview');
    const fgPreview = document.getElementById('fgPreview');
    if (bgInput) bgInput.addEventListener('input', function() { bgPreview.style.background = this.value; updatePreview(); });
    if (fgInput) fgInput.addEventListener('input', function() { fgPreview.style.background = this.value; updatePreview(); });
  }
  else if (v === 'url') srcFields.innerHTML = `<label>Image URL</label><input id="imgurl">`;
  else if (v === 'gravatar') srcFields.innerHTML = `<label>Gravatar email</label><input id="gemail">`;

  ['gh','initials','bg','fg','imgurl','gemail'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.oninput = updatePreview;
  });
}

function updatePreview(){
  const v = source.value;
  if (v === 'github') {
    const gh = (document.getElementById('gh')||{}).value || userData.username;
    previewImg.src = `/preview.png?type=github&gh=${encodeURIComponent(gh)}&size=512`;
  }
  else if (v === 'initials') {
    const initials = (document.getElementById('initials')||{}).value || 'AB';
    const bg = (document.getElementById('bg')||{}).value || '#7c5cff';
    const fg = (document.getElementById('fg')||{}).value || '#ffffff';
    previewImg.src = `/preview.png?type=initials&initials=${encodeURIComponent(initials)}&bg=${encodeURIComponent(bg)}&fg=${encodeURIComponent(fg)}&size=512`;
  }
  else if (v === 'url') {
    const u = (document.getElementById('imgurl')||{}).value;
    previewImg.src = u || '/placeholder.png';
  }
  else if (v === 'gravatar') {
    const email = (document.getElementById('gemail')||{}).value || '';
    previewImg.src = `/preview.png?type=gravatar&email=${encodeURIComponent(email)}&size=512`;
  }
}

source.onchange = renderFields;
setFieldsFromUser();

document.getElementById('saveBtn').onclick = async ()=> {
  const payload = { username: userData.username, source: source.value };
  if (source.value === 'github') payload.gh = (document.getElementById('gh')||{}).value.trim();
  if (source.value === 'initials') {
    payload.initials = (document.getElementById('initials')||{}).value.trim();
    payload.bg = (document.getElementById('bg')||{}).value.trim();
    payload.fg = (document.getElementById('fg')||{}).value.trim();
  }
  if (source.value === 'url') payload.url = (document.getElementById('imgurl')||{}).value.trim();
  if (source.value === 'gravatar') payload.email = (document.getElementById('gemail')||{}).value.trim();

  const btn = document.getElementById('saveBtn');
  btn.disabled = true; btn.textContent = 'Saving...';
  try {
    const res = await fetch('/api/save_avatar', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    const j = await res.json();
    if (j.success) {
      location.reload();
    } else {
      alert(j.error || 'Save failed');
    }
  } catch(e) {
    alert('Network error');
  } finally {
    btn.disabled=false; btn.textContent='Save changes';
  }
};
</script>
</body>
</html>